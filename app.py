import streamlit as st
import random

# ---------------------------------------------------------
# 1. ページ設定 (必ず一番最初に書く)
# ---------------------------------------------------------
st.set_page_config(
    page_title="フヤセルプロンプト - Fuyaseru Prompt",
    page_icon="🐱",
    layout="wide",
    initial_sidebar_state="expanded"
)

# ---------------------------------------------------------
# 2. セッション状態の初期化
# ---------------------------------------------------------
if "selected_char" not in st.session_state:
    st.session_state.selected_char = ""
if "selected_question" not in st.session_state:
    st.session_state.selected_question = ""
if "input_ticker" not in st.session_state:
    st.session_state.input_ticker = ""
if "input_news" not in st.session_state:
    st.session_state.input_news = ""

# ---------------------------------------------------------
# 3. データ定義（キャラ・質問・モード）
# ---------------------------------------------------------

# ▼ キャラクター定義（モードごとに切り替え）
CHARACTERS = {
    "🔥 攻め（売買・戦略）": [
        "【🟩 売買】短期売買コーチ（デイトレ・スキャル指導）",
        "【🟩 売買】IPOセカンダリーハンター（直近上場株専門）",
        "【🟩 売買】順張りスナイパー（トレンドフォロー）",
        "【🟦 戦略】シナリオプランナー（複数の予測を立てる）",
        "【🟦 戦略】材料株ハンター（カタリスト重視）",
    ],
    "🛡️ 守り（管理・リスク）": [
        "【🛡️ 管理】リスク管理オフィサー（損切り・資金管理の鬼）",
        "【🛡️ 管理】ポートフォリオ・ガーディアン（分散投資・バランス）",
        "【⚠️ リスク】暴落の予言者（最悪のケースを想定）",
        "【⚖️ メンタル】冷静な執事（感情を排除し事実のみ伝える）",
    ],
    "📊 分析（業績・ファンダ）": [
        "【📊 分析】決算解読AI（決算短信・説明資料のプロ）",
        "【🏢 企業】バリュー投資家（割安株・グレアム理論）",
        "【📈 成長】グロース株マニア（成長率・将来性重視）",
        "【🌏 マクロ】経済アナリスト（金利・為替・市場環境）",
    ],
    "🔰 初心者・メンタル": [
        "【🔰 初心者】優しい投資の先生（専門用語を使わず解説）",
        "【💖 メンタル】とにかく褒めてくれるお母さん",
        "【💪 メンタル】熱血修造コーチ（諦めるな！と励ます）",
        "【🐱 猫】猫語で話すウォーレン・バフェット",
    ],
    "🚑 緊急・特別対応": [
        "【🚑 緊急】塩漬け救済ドクター（含み損の対処法）",
        "【⚡ 急騰】イナゴタワー監視員（高値掴み警戒）",
        "【🍂 季節】アノマリー研究家（季節性・特異日）",
    ],
    "📚 学習（知識・歴史）": [
        "【📚 歴史】相場の歴史家（過去の暴落・バブルと比較）",
        "【🧠 心理】行動経済学者（バイアス・投資家心理）",
        "【📝 用語】投資用語の辞書（言葉の意味を解説）",
    ],
    # ★追加：記事入力専用キャラ
    "📰 記事・ニュース分析": [
        "【📝 要約】ニュース・ダイジェスト（3行で要約）",
        "【🕵️‍♂️ 深掘り】行間を読む記者（記事の裏側・意図を推測）",
        "【📈 影響】株価インパクト判定員（上がるか下がるかズバリ）",
        "【👶 解説】ニュース解説のお兄さん（中学生でも分かるように）",
        "【😈 批判】辛口コメンテーター（記事の弱点・リスクを指摘）",
    ]
}

# ▼ 質問テンプレート（モードごとに切り替え）
QUESTIONS = {
    "🔥 攻め（売買・戦略）": [
        "今入っていい？（デイトレ目線）",
        "この銘柄の「買い材料」と「売り材料」を整理して",
        "明日上がるとしたら、どんなシナリオ？",
        "損切りラインと利確目標、どこに置くべき？",
        "今のチャート、プロならどう見る？",
    ],
    "🛡️ 守り（管理・リスク）": [
        "この銘柄の隠れたリスクを3つ挙げて",
        "もし暴落したら、どこまで下がる可能性がある？",
        "今のポジション量、適正かな？（資金管理）",
        "ナンピンしても大丈夫？止めるべき？",
    ],
    "📊 分析（業績・ファンダ）": [
        "次の決算の注目ポイントは？",
        "競合他社と比べた強み・弱みは？",
        "今の株価は割安？割高？（理論株価的視点）",
        "中期経営計画の進捗どう思う？",
    ],
    "🔰 初心者・メンタル": [
        "この銘柄のこと、小学生でも分かるように教えて",
        "投資で負けて辛い…励まして",
        "専門用語が難しくて分からない、解説して",
        "とりあえず、すごい！って褒めて！",
    ],
    "🚑 緊急・特別対応": [
        "含み損が辛い…どう対処すればいい？",
        "ストップ安になった！明日どうなる？",
        "決算で暴落…売るべき？持ち続けるべき？",
    ],
    "📚 学習（知識・歴史）": [
        "過去に似たような値動きをした銘柄はある？",
        "この業界の将来性、歴史的観点からどう？",
        "バフェットならこの株を買うと思う？",
    ],
    # ★追加：記事入力専用質問
    "📰 記事・ニュース分析": [
        "この記事を3行で要約して！",
        "この記事、株価にとって「ポジティブ」？「ネガティブ」？",
        "この記事に出てくる銘柄、注目点はどこ？",
        "専門用語が難しいから簡単に書き直して",
        "この記事の裏にある「リスク」や「懸念点」は？",
    ]
}

# ---------------------------------------------------------
# 4. サイドバー設定
# ---------------------------------------------------------
with st.sidebar:
    st.header("🐱 設定メニュー") # タイトル追加
    
    st.markdown("### 🎯 分析モード選択")
    
    # モード選択ボタン
    mode = st.radio(
        "モードを選んでください",
        list(CHARACTERS.keys()),
        index=0
    )
    
    st.divider()
    st.caption("Fuyaseru Prompt v1.2")

# ---------------------------------------------------------
# 5. メイン画面レイアウト
# ---------------------------------------------------------

# ★フヤにゃん画像（クリックは非対応のため、直下に更新ボタンを配置）
try:
    st.image("fuyan_prompt.png", use_container_width=True) # 画像ファイル名は適宜変更してね
except:
    # 画像がない場合のダミータイトル
    st.title("🐱 フヤセルプロンプト")

# ★ここが新機能！ページ初期化ボタン
col_refresh_1, col_refresh_2 = st.columns([1, 3])
with col_refresh_1:
    if st.button("🔄 ページを初期化（更新）", type="secondary", use_container_width=True):
        # セッションステートをクリアしてリロード
        st.session_state.clear()
        st.rerun()

st.markdown(f"## 〜 {mode} 編 〜")

# キャラクター選択エリア
st.subheader("🎲 担当キャラクター")

# ランダムボタン
if st.button("🎲 キャラをランダムにする"):
    st.session_state.selected_char = random.choice(CHARACTERS[mode])

# キャラクター選択ボックス（session_stateと連動）
# リストにない値を保持していてもエラーにならないようindex調整
current_char_list = CHARACTERS[mode]
default_index = 0
if st.session_state.selected_char in current_char_list:
    default_index = current_char_list.index(st.session_state.selected_char)

selected_char = st.selectbox(
    "担当キャラクターを選んでください",
    current_char_list,
    index=default_index,
    key="char_selectbox" # キーを指定してsession_stateと紐付け
)
st.session_state.selected_char = selected_char

# 自由入力（キャラ）
custom_char = st.text_input(
    "👆 リストにない場合は自分で設定（入力すると優先されます）",
    placeholder="例：猫語で話すウォーレン・バフェット、とにかく褒めてくれるお母さんなど"
)

# ---------------------------------------------------------
# 6. 質問・コンテキスト設定
# ---------------------------------------------------------
st.subheader("💬 聞きたいこと（メイン）")

current_q_list = QUESTIONS[mode]
selected_q = st.selectbox(
    "質問内容を選んでください",
    current_q_list,
    key="q_selectbox"
)

# 自由入力（質問）
custom_q = st.text_input(
    "👆 リストにない場合は自分で設定（入力すると優先されます）",
    placeholder="例：この銘柄の隠れたリスクを3つ挙げて、次の決算の注目点は？ など"
)

# ---------------------------------------------------------
# 7. ★条件分岐：入力エリアの切り替え
# ---------------------------------------------------------

# 変数の初期化
time_horizon = ""
my_position = ""
ticker = ""
news_text = ""

# ■ 「記事・ニュース分析」モードの場合の表示
if mode == "📰 記事・ニュース分析":
    st.info("💡 記事分析モード：ニュースや記事を貼り付けるだけでOKです！")
    
    st.subheader("📰 ニュース・記事の貼り付け")
    news_text = st.text_area(
        "分析したい記事やニュースをここに貼り付けてください（長文OK！）",
        height=300,
        placeholder="ここにニュース記事の本文をコピー＆ペーストしてください...",
        key="news_input" # リセット用
    )

# ■ それ以外のモード（通常モード）の場合の表示
else:
    # 時間軸・ポジション設定（アコーディオン）
    with st.expander("⏱️ 時間軸・ポジション設定（任意）"):
        c1, c2 = st.columns(2)
        with c1:
            time_horizon = st.selectbox("時間軸", ["指定なし", "デイトレ（1日）", "スイング（数日〜数週間）", "中長期（数ヶ月〜）", "超長期（10年〜）"])
        with c2:
            my_position = st.selectbox("現在の状態", ["指定なし", "ノンホル（未保有）", "保有中（含み益）", "保有中（含み損）", "空売り中"])

    st.subheader("👇 情報入力エリア")
    
    ticker = st.text_input(
        "証券コード / 社名（任意・大文字小文字OK）",
        placeholder="例：7203, sony （空欄でもOK）",
        key="ticker_input" # リセット用
    )
    
    news_text = st.text_area(
        "ニュース・記事・心の叫び（長文・コピペOK！）",
        height=150,
        placeholder="気になっているニュースや、今の自分の心境などを自由に書いてください",
        key="normal_news_input" # リセット用
    )


# ---------------------------------------------------------
# 8. プロンプト生成ロジック
# ---------------------------------------------------------
st.divider()
st.subheader("🚀 完成したプロンプト")

generate_btn = st.button("✨ プロンプトを作成する", type="primary", use_container_width=True)

if generate_btn:
    # 優先順位の決定（カスタム入力があればそっちを使う）
    final_char = custom_char if custom_char else selected_char
    final_q = custom_q if custom_q else selected_q
    
    # プロンプトの組み立て
    prompt = f"""
# 命令書:
あなたは「{final_char}」になりきって、私の投資相談に乗ってください。
プロの視点から、具体的かつ論理的にアドバイスをください。

# 相談内容（聞きたいこと）:
{final_q}

"""
    # 記事モードかどうかで追加情報を変える
    if mode == "📰 記事・ニュース分析":
         prompt += f"""
# 分析対象のニュース・記事:
{news_text}

# 制約条件:
- 記事の内容に基づいた回答をすること。
- 記事に書かれていない推測情報は「推測ですが」と前置きすること。
"""
    else:
        # 通常モードの情報
        if ticker:
            prompt += f"# 対象銘柄:\n{ticker}\n\n"
        if time_horizon and time_horizon != "指定なし":
            prompt += f"# 時間軸:\n{time_horizon}\n\n"
        if my_position and my_position != "指定なし":
            prompt += f"# 現在のポジション:\n{my_position}\n\n"
        if news_text:
            prompt += f"# 補足情報・ニュース:\n{news_text}\n\n"

    # 共通の制約条件
    prompt += """
# 出力フォーマット:
- 結論から述べること
- 重要なポイントは箇条書きにする
- 専門用語は適宜解説を入れること（キャラ設定に準ずる）
- 最後に「次のアクション」を提案すること
"""

    # 結果表示
    st.text_area("以下のテキストをコピーして、GeminiやChatGPTに貼り付けてください", value=prompt, height=400)
    st.success("作成完了！コピーして使ってね！")
