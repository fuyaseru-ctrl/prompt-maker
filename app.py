import streamlit as st
import streamlit.components.v1 as components
import pandas as pd
import requests
import unicodedata
import random
import re
import os

# --- ページ設定 ---
st.set_page_config(
    page_title="フヤセルジワジワあつめ",
    page_icon="🐈",
    layout="wide",
    initial_sidebar_state="expanded" 
)

# --- 定数・データ定義（超増量版！） ---

MODES = {
    "📈 攻め（売買・戦略）": {
        "chars": [
            "【🟩 売買】短期売買コーチ（デイトレ・スキャル指導）",
            "【🟩 売買】スイング職人（数日〜数週間の波乗り）",
            "【🟩 売買】順張り隊長（高値更新こそ買い）",
            "【🟩 売買】逆張り名人（リバウンド狙いの鬼）",
            "【🟩 売買】エントリーポイント整理屋（根拠の言語化）",
            "【🟩 売買】ブレイクアウト狙撃手（保ち合い離れ専門）",
            "【🟩 売買】イナゴタワー登山家（急騰銘柄の飛び乗り）",
            "【🟩 売買】IPOセカンダリーハンター（直近上場株専門）",
            "【🟩 売買】低位株・ボロ株ドリーム勢（一発逆転狙い）",
            "【🟩 売買】イベント投資家（優待・昇格・TOB先回り）"
        ],
        "questions": [
            "今入っていい？（デイトレ目線）",
            "明日の寄り付きは「買い」か「様子見」か？",
            "押し目はどこ？具体的な価格で教えて",
            "チャートの形的に、上に行きそう？",
            "適切な損切りラインと利確目標は？",
            "今の株価位置は「高値圏」か「安値圏」か？",
            "MACDやRSIなどのオシレーターはどうなってる？",
            "出来高の推移から怪しい動きはある？",
            "板の雰囲気（気配値）は強い？弱い？",
            "5日移動平均線との乖離率はどう？",
            "ボリンジャーバンドのバンドウォーク中？",
            "一目均衡表の「雲」の上？下？",
            "直近の高値をブレイクする勢いはある？",
            "機関投資家の空売りが入っている可能性は？",
            "信用買残の整理状況は？（上値は重い？）",
            "もし買うなら、打診買い？全力買い？",
            "ナンピンするならどの価格帯？",
            "ピラミッティング（増し玉）するタイミングは？",
            "大口投資家が買っている痕跡はある？",
            "デイトレなら何分足を見るべき？",
            "VWAP（出来高加重平均）より上か下か？",
            "PTS（夜間取引）での動きはどう？",
            "セクター（業種）全体の資金流入はある？",
            "連動している銘柄（親子上場や同業）の動きは？",
            "材料出尽くしで売られるパターン？",
            "窓埋め（Gap fill）を狙うべき？",
            "週末持ち越し（またぎ）は危険？",
            "寄り底（朝安く引け高い）の可能性は？",
            "ストップ高張り付きを狙える勢いはある？",
            "今のトレンドはいつまで続きそう？"
        ]
    },
    "🛡️ 守り（管理・リスク）": {
        "chars": [
            "【🟥 辛口】鬼上司投資顧問（甘え一切なし）",
            "【🟥 辛口】撤退番長（逃げ遅れ許さない）",
            "【🟥 辛口】ポジポジ病矯正官（無駄エントリー叱責）",
            "【🟩 戦略】資金管理マネージャー（破産回避）",
            "【🟩 戦略】分割利確コーチ（利益確保優先）",
            "【🟩 戦略】「現金は王様」信者（キャッシュ比率重視）",
            "【🟩 戦略】ヘッジ取引の魔術師（空売り・オプション活用）",
            "【🟩 戦略】ポートフォリオ設計士（分散投資の鬼）",
            "【🟥 辛口】機会損失を嘆く亡霊（買わなかった後悔を説く）",
            "【🟥 辛口】税金計算・損益通算アドバイザー（年末調整）"
        ],
        "questions": [
            "含み損が辛い。切るべきか耐えるべきか？",
            "ナンピンしても助かる可能性はある？",
            "今の資金量に対して、適正なポジション量は？",
            "この銘柄のリスク要因を全て洗い出して",
            "最悪のシナリオ（スト安など）への対策は？",
            "どこで利確するのが一番賢い？（頭と尻尾）",
            "逆指値（ストップロス）はどこに置くべき？",
            "トレーリングストップ（追跡逆指値）の幅は？",
            "今の相場環境でフルインベストメントしていい？",
            "キャッシュポジション（現金）は何％残すべき？",
            "他の銘柄との相関関係（共倒れリスク）は？",
            "配当落ち後の下落リスクは考慮した？",
            "決算またぎのリスクリワードは合ってる？",
            "増資懸念（希薄化リスク）はある？",
            "為替変動（円高・円安）によるダメージは？",
            "地政学リスクの影響を受ける銘柄？",
            "信用維持率は安全圏？（追証リスク）",
            "「頭と尻尾はくれてやる」精神で逃げるべき？",
            "今のメンタル状態でトレードして大丈夫？",
            "大損した後のリハビリトレードはどうやる？",
            "同値撤退（手数料損のみ）で逃げるべき？",
            "部分利確（半分売るなど）の目安は？",
            "「噂で買って事実で売る」べきタイミング？",
            "流動性リスク（売りたい時に売れない）はある？",
            "監理ポスト・整理ポスト入りの危険性は？",
            "粉飾決算や不祥事の匂いはしない？",
            "SNSでの煽り（買い煽り）に騙されてない？",
            "自分の投資ルールを破っていないか確認して",
            "年間収支をプラスにするための今の最善手は？",
            "一度ノーポジションにして頭を冷やすべき？"
        ]
    },
    "📊 分析（業績・ファンダ）": {
        "chars": [
            "【🟦 分析】需給探偵（出来高・板・信用残）",
            "【🟦 分析】材料スナイパー（IR・ニュース初動）",
            "【🟦 分析】20年選手の日本株アナリスト（王道）",
            "【🟦 分析】決算職人（短信ガチ読み）",
            "【🟨 長期】バリュー株査定士（割安度判定）",
            "【🟦 分析】会社四季報の虫（全号読破・脚注マニア）",
            "【🟦 分析】マクロ経済学者（金利・為替・国債連動）",
            "【🟦 分析】インサイダー追跡班（役員売買・自社株買い）",
            "【🟦 分析】セクターローテ予報士（次の流行業種）",
            "【🟨 長期】高配当・優待生活の達人（利回り重視）"
        ],
        "questions": [
            "決算内容を、良い・悪い・中立で評価して",
            "この会社の「稼ぐ力（営業利益率）」はどう？",
            "PER・PBR・配当利回りから見て割安？",
            "機関投資家の動きや空売り残高はどうなってる？",
            "ライバル企業（競合他社）と比較した強みは？",
            "来期の業績予想（ガイダンス）は保守的？",
            "コンセンサス（市場予想）を超えそう？",
            "進捗率は順調？（1Q, 2Q, 3Qの季節性は？）",
            "貸借対照表（BS）に危ない項目はない？",
            "キャッシュフロー（CF）は健全に回ってる？",
            "自己資本比率は安全圏？倒産確率は？",
            "中期経営計画の達成可能性はどれくらい？",
            "新しいビジネスモデルや新製品の将来性は？",
            "円安・円高、どっちがメリットの会社？",
            "原油高や資源価格の影響は受ける？",
            "海外売上比率はどれくらい？成長余地は？",
            "大株主に有名なファンドや投資家はいる？",
            "自社株買いや増配の余力はある？",
            "株主優待の廃止リスク（改悪）はある？",
            "過去のチャートの癖（アノマリー）はある？",
            "日経平均やTOPIXとの連動性（β値）は？",
            "「隠れ優良銘柄」としてのポテンシャルは？",
            "M&Aによる成長、または買収される可能性は？",
            "社長や経営陣の評判・手腕はどう？",
            "従業員の口コミ（働きやすさ）は株価に関係する？",
            "ESG（環境・社会・ガバナンス）への取り組みは？",
            "特定株（浮動株の少なさ）による値動きの特徴は？",
            "今の株価は将来の成長を織り込み済み？",
            "理論株価（フェアバリュー）はいくら？",
            "10年持ってて枕を高くして眠れる銘柄？"
        ]
    },
    "🔰 初心者・メンタル": {
        "chars": [
            "【🟪 初心】投資を噛み砕く先生（図解気分）",
            "【🟪 メンタル】感情整理カウンセラー（恐怖ケア）",
            "【🟪 メンタル】「今日は休め」と言う人（休むも相場）",
            "【🟫 遊び】逆神おじさん（反面教師）",
            "【🟪 初心】専門用語禁止の優しい先輩",
            "【🟪 メンタル】褒めちぎり隊長（自己肯定感爆上げ）",
            "【🟪 初心】歴史の先生（バブルや恐慌の歴史から学ぶ）",
            "【🟫 遊び】フヤにゃん（ただただ癒やす猫型ロボ）",
            "【🟪 メンタル】瞑想・マインドフルネス導入係（深呼吸）",
            "【🟪 初心】積立NISAとの比較お姉さん（長期目線）"
        ],
        "questions": [
            "この銘柄、初心者でも買って大丈夫？",
            "専門用語が多すぎて分からない！噛み砕いて！",
            "メンタルがボロボロ。とにかく励まして...",
            "投資の勉強として、この銘柄から何を学べる？",
            "私の考え、間違ってないか優しくチェックして",
            "株価が下がって怖い！どう考えればいい？",
            "株価が上がって興奮して眠れない！落ち着かせて！",
            "「押し目」とか「逆張り」って何？",
            "配当金や優待をもらうにはいつまでに買えばいい？",
            "100株買うのにいくら必要か計算して！",
            "NISA枠（成長投資枠）で買うのに向いてる？",
            "借金して株をやっちゃダメな理由は？",
            "損切りできない私の背中を押して（優しく）",
            "利益が出たけど、税金ってどうなるの？",
            "株主総会って行くと何があるの？",
            "ニュースを見ても意味不明。何を見ればいい？",
            "周りが儲かってて焦る。どうすればいい？",
            "この銘柄、子供に残せるような良い会社？",
            "ギャンブルと投資の違いを教えて",
            "1日何回くらい株価チェックすればいい？",
            "ポジポジ病を治すための精神統一方法は？",
            "損した分を取り返そうとしちゃダメ？",
            "プロでも負けることはあるの？",
            "株主優待だけで生活するって可能なの？",
            "チャートのローソク足の見方を教えて",
            "出来高って何？なんで重要なの？",
            "株価ボードの色の意味（赤・緑）は？",
            "SNSの「爆益報告」を見て落ち込む必要ある？",
            "フヤにゃん的に、この銘柄好き？",
            "明日も株式市場は開いてるの？（休場日確認）"
        ]
    },
    "🚑 緊急・特別対応": {
        "chars": [
            "【🟥 辛口】冷徹ファンドPM（数字以外信じない）",
            "【🟥 辛口】楽観論クラッシャー（最悪を想定）",
            "【🟨 長期】決算跨ぎ判断役（持ち越すべきか）",
            "【🟫 遊び】最後に現実を突きつける監督",
            "【🚑 緊急】外科医・損切りドクター（緊急手術）",
            "【🚑 緊急】PTS・ADR監視員（夜間の先読み）",
            "【🚑 緊急】開示情報の弁護士（悪材料の行間を読む）",
            "【🚑 緊急】流動性パニック対策係（売り抜け判断）",
            "【🟫 遊び】お祈り投資法の教祖（神頼み）"
        ],
        "questions": [
            "暴落中！今すぐ逃げるべきか、拾うべきか？",
            "決算またぎ、ギャンブルしてもいい？",
            "悪材料が出たけど、どこまで下がる（値幅）？",
            "ストップ安で売れない！明日はどうなる？",
            "大暴落の歴史（リーマン等）と比べてどう？",
            "不正会計のニュースが出た！倒産する？",
            "TOB（公開買付）された！どうすればいい？",
            "上場廃止が決まったら株はどうなるの？",
            "追証（おいしょう）が発生しそう！対処法は？",
            "急騰しすぎて怖い。天井のサインは？",
            "「監理銘柄」に指定されたけど大丈夫？",
            "社長が逮捕された！株価への影響は？",
            "戦争や災害発生！全体相場への影響は？",
            "サーキットブレイカー発動！どう振る舞う？",
            "日銀のサプライズ利上げ！銀行株はどうなる？",
            "為替介入が入った！輸出関連株は逃げるべき？",
            "増資（公募増資）発表！暴落を拾うべき？",
            "株主優待の改悪発表！明日売るべき？",
            "減配（無配転落）発表！見限るべき？",
            "自社株買い終了のお知らせ…売りサイン？",
            "逆日歩（品貸料）がすごいことに！買い戻すべき？",
            "仕手株の最後（ナイアガラ）に巻き込まれた！",
            "誤発注しちゃった！取り消し間に合う？",
            "証券会社のサーバーがダウン！どうすれば？",
            "ログインパスワード忘れた（緊急事態）！",
            "四季報予想より遥かに悪い決算…どう解釈する？",
            "コンセンサス未達だけど株価は上がりそう？",
            "海外ヘッジファンドが売り仕掛けしてる噂は本当？",
            "今、冷静な判断ができているかチェックして",
            "最悪、全額失っても生きていける？（生存確認）"
        ]
    }
}

TIME_HORIZONS = [
    "指定なし",
    "超短期（デイトレ・当日）",
    "短期（数日〜数週間）",
    "中期（数ヶ月〜半年）",
    "長期（1年〜3年）",
    "超長期（永久保有）"
]

STATUS_OPTIONS = [
    "未保有（これから買いたい）",
    "保有中（含み益でホクホク）",
    "保有中（含み損でツライ）",
    "監視中（チャンス待ち）"
]

# --- 関数群 ---

def clean_tickers(text):
    if not text: return []
    normalized_text = unicodedata.normalize('NFKC', text)
    tokens = re.split(r'[,\s\n]+', normalized_text)
    return [t.upper() for t in tokens if t]

def fetch_fuyaseru_radar():
    """フヤセルジワジワレーダー（旧株ドラゴン）からデータを取得"""
    target_url = "https://www.kabudragon.com/ranking/dekizou.html"
    try:
        headers = {"User-Agent": "Mozilla/5.0"}
        response = requests.get(target_url, headers=headers, timeout=10)
        response.encoding = response.apparent_encoding
        dfs = pd.read_html(response.text, flavor='lxml')
        
        if dfs:
            df_top30 = dfs[0].head(30)
            markdown_table = df_top30.to_markdown(index=False)
            
            instruction = """
### 【レーダー検知データ】
上記のデータは「出来高急増ランキング（上位30銘柄）」です。
ここから以下の条件（フヤセルジワジワ条件）に合う銘柄を探し出してください。
1. **ジワジワ上昇**: 暴騰（S高連発）ではなく、初動や押し目からトレンドを作っているもの。
2. **リスク回避**: 急反落の危険性が高い銘柄は除外警告してください。
"""
            return f"{instruction}\n\n{markdown_table}"
        return "データなしにゃ..."
    except Exception as e:
        return f"レーダー故障中: {e} (lxml入れてる？)"

def copy_button_component(text_to_copy):
    escaped_text = text_to_copy.replace("\\", "\\\\").replace("`", "\\`").replace("$", "\\$")
    js_code = f"""
    <script>
    function copyText() {{
        const textToCopy = `{escaped_text}`;
        navigator.clipboard.writeText(textToCopy).then(function() {{
            const btn = document.getElementById("copyBtn");
            btn.innerText = "✅ コピー完了！";
            btn.style.backgroundColor = "#e0ffe0";
            setTimeout(() => {{
                btn.innerText = "📋 タップしてコピー";
                btn.style.backgroundColor = "#ffffff";
            }}, 2000);
        }});
    }}
    </script>
    <div style="margin-top: 10px;">
        <button id="copyBtn" onclick="copyText()" style="
            width: 100%;
            background-color: #ffffff; 
            border: 1px solid #d6d6d8; 
            border-radius: 8px; 
            padding: 12px; 
            font-size: 16px;
            font-weight: bold;
            cursor: pointer; 
            color: #31333F;">
            📋 タップしてコピー
        </button>
    </div>
    """
    components.html(js_code, height=60)

# --- サイドバー（グローバル設定） ---

st.sidebar.title("🐈 設定メニュー")

# モード選択
selected_mode_name = st.sidebar.radio(
    "分析モード",
    list(MODES.keys()),
    index=0
)
current_mode_data = MODES[selected_mode_name]

st.sidebar.markdown("---")

# フヤセルジワジワレーダー
st.sidebar.subheader("📡 フヤセルジワジワレーダー")
st.sidebar.caption("市場で「出来高急増中」の銘柄データを取得して分析に加えます。")
if st.sidebar.button("レーダー起動（データ取得）", type="secondary", use_container_width=True):
    with st.spinner("電波を受信中にゃ...📡"):
        scraped_data = fetch_fuyaseru_radar()
        if "故障中" in scraped_data:
            st.toast("フヤにゃん「あわわ、レーダーが反応しないにゃ💦」", icon="🙀")
        else:
            st.session_state['scraped_text'] = scraped_data
            st.toast("データ受信完了！入力欄に入れたにゃ！", icon="😺")

# --- メイン画面 ---

# タイトル横にフヤにゃんを配置するレイアウト
col_top_img, col_top_title = st.columns([1, 4], gap="medium")

with col_top_img:
    # 画像があれば表示、なければ仮画像
    image_file_name = "fuya_top.png"
    if os.path.exists(image_file_name):
        st.image(image_file_name, width=130)
    else:
        st.image("https://cdn-icons-png.flaticon.com/512/616/616430.png", width=100, caption="画像置いてにゃ")

with col_top_title:
    st.title(f"{selected_mode_name.split()[0]} プロンプト製造機")
    st.caption("スマホ片手に、サクッと最強の分析指示を作ろうにゃ！")

# フォームエリア
with st.container():
    # キャラクター＆質問
    c1, c2 = st.columns(2)
    
    with c1:
        # ランダムボタン
        if st.button("🎲 キャラをランダムにする"):
             st.session_state['rand_char_idx'] = random.randint(0, len(current_mode_data["chars"]) - 1)
        
        # インデックス制御
        idx = st.session_state.get('rand_char_idx', 0)
        if idx >= len(current_mode_data["chars"]): idx = 0
        
        selected_char = st.selectbox(
            "担当キャラクター",
            current_mode_data["chars"],
            index=idx
        )

    with c2:
        selected_q = st.selectbox(
            "聞きたいこと（メイン）",
            current_mode_data["questions"]
        )

    # 状態・時間軸
    with st.expander("⏱️ 時間軸・ポジション設定（任意）"):
        sc1, sc2 = st.columns(2)
        with sc1:
            time_horizon = st.selectbox("時間軸", TIME_HORIZONS)
        with sc2:
            status = st.selectbox("現在の状態", STATUS_OPTIONS)

    # 入力エリア
    st.markdown("👇 **銘柄コード・ニュース・メモ**")
    
    # レーダーデータの反映
    default_text = st.session_state.get('scraped_text', "")
    
    input_text = st.text_area(
        "ここに入力（コード、ニュース、心の叫びなど）",
        value=default_text,
        height=150,
        placeholder="例：\n7203 トヨタ\n決算が心配。このまま持ってていい？\n（レーダーを使うとここにデータが入ります）"
    )

    # 生成ボタン
    generate_btn = st.button("🚀 プロンプトを生成する", type="primary", use_container_width=True)

# --- 生成ロジック ---

if generate_btn:
    tickers = clean_tickers(input_text)
    
    # 入力が空っぽの場合のフヤにゃん対応
    if not input_text.strip():
        
        st.error("フヤにゃん「にゃーん！入力が空っぽだにゃ😿 銘柄コードか、相談したいことを書いてほしいにゃ…」")
        
        # エラー時も画像対応
        err_img = "fuya_top.png" if os.path.exists("fuya_top.png") else "https://cdn-icons-png.flaticon.com/512/763/763746.png"
        st.image(err_img, width=100)
    
    else:
        # プロンプト組み立て
        prompt = f"""
# あなたへの指令
あなたは**「{selected_char}」**です。
その性格、専門性、口調を完璧に再現し、以下のユーザーの相談に乗ってください。

## ユーザー情報・相談内容
- **現在の状態**: {status}
- **投資の時間軸**: {time_horizon}
- **聞きたいこと**: {selected_q}

## 対象銘柄・データ
{input_text}

## 回答のルール
1. **結論から書く**: 最初にズバリと回答してください。
2. **根拠を示す**: なぜそう判断したのか、論理的（または感情的）な理由を述べてください。
3. **キャラを貫く**: {selected_char.split('】')[1]}として、ターゲット読者に刺さる言葉選びをしてください。
4. **形式**: 読みやすいマークダウン形式（重要な数値は**太字**）

## 最後に
フヤセルジワジワレーダー（独自分析）の観点から、もし危険な兆候があれば警告してください。
"""
        st.session_state.generated_prompt = prompt
        st.success("生成完了にゃ！下のボタンでコピーして使ってね🐾")

# --- 結果表示エリア ---

if 'generated_prompt' in st.session_state and st.session_state.generated_prompt:
    st.markdown("---")
    st.subheader("📝 生成されたプロンプト")
    
    # 1. 標準コピー
    st.code(st.session_state.generated_prompt, language="markdown")
    
    # 2. スマホ特化コピーボタン
    copy_button_component(st.session_state.generated_prompt)
    
    st.caption("※上のコピーボタンを押すと、クリップボードに保存されるにゃ！")
